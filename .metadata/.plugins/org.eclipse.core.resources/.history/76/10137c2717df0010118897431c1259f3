package com.example.event.service;

import java.math.BigDecimal;
import java.time.OffsetDateTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;

import com.example.event.dto.response.detail.EventDetailResponse;
import com.example.event.dto.response.detail.EventReviewItemResponse;
import com.example.event.exception.ResourceNotFoundException;
import com.example.event.repository.EventDetailProjection;
import com.example.event.repository.EventRepository;

@Service
public class EventDetailService {

    private final EventRepository eventRepository;
    private final EventFavoriteRepository favoriteRepository;

    public EventDetailService(EventRepository eventRepository, EventFavoriteRepository favoriteRepository) {
        this.eventRepository = eventRepository;
        this.favoriteRepository = favoriteRepository;
    }
    
    private static final DateTimeFormatter REVIEW_DATE_FORMATTER = 
        DateTimeFormatter.ofPattern("yyyy/MM/dd").withZone(ZoneId.of("Asia/Ho_Chi_Minh"));

    /**
     * @param eventId The ID of the event
     * @param currentUserId The ID of the logged-in user (null if guest)
     */
    public EventDetailResponse getEventDetails(Long eventId, Long currentUserId) {
        
        // 1. Fetch Core Event Details
        EventDetailProjection coreData = eventRepository.findEventDetailProjection(eventId)
            .orElseThrow(() -> new ResourceNotFoundException("Event not found with ID: " + eventId));
            
        // 2. Map Core Data
        Long id = coreData.getId();
        String title = coreData.getTitle();
        String description = coreData.getDescription();
        BigDecimal price = coreData.getPrice();
        OffsetDateTime startDatetime = coreData.getStartDatetime();
        OffsetDateTime endDatetime = coreData.getEndDatetime();
        String categoryName = coreData.getCategoryName();

        String district = coreData.getDistrict();
        String address = coreData.getAddress();
        String city = coreData.getCity();
        
        String locationSummary = String.format("%s • %s • Price $%s", district, city, price.toString());
        String fullAddress = String.format("%s, %s, %s", address, district, city);
        boolean isFavorite = false;
        if (currentUserId != null) {
            isFavorite = favoriteRepository.isFavorite(currentUserId, eventId);
        }
        // 3. Fetch and Map Reviews
        List<Object[]> reviewObjects = eventRepository.findEventReviewsByEventId(eventId);
        List<EventReviewItemResponse> reviews = reviewObjects.stream()
        	    .map(row -> {
        	        String userName = (String) row[0];
        	        Integer rating = (Integer) row[1];
        	        String commentText = (String) row[2]; // Index 2 is the text
        	        OffsetDateTime createdAt = (OffsetDateTime) row[3]; // Index 3 is the date
        	        Long authorId = (Long) row[4];

        	        Boolean isMyComment = (currentUserId != null) && currentUserId.equals(authorId);

        	        // BE CAREFUL WITH ORDER HERE:
        	        return new EventReviewItemResponse(
        	            userName,         // 1. userName
        	            rating,           // 2. rating
        	            REVIEW_DATE_FORMATTER.format(createdAt), // 3. date string
        	            commentText,      // 4. comment text
        	            isMyComment       // 5. boolean
        	        );
        	    })
        	    .collect(Collectors.toList());

        // 4. Fetch Images
        List<String> images = eventRepository.findEventImageUrlsByEventId(eventId);
        
        // 5. Build Final DTO
        return new EventDetailResponse(
            id, 
            title, 
            locationSummary, 
            fullAddress, 
            description, 
            price, 
            startDatetime, 
            endDatetime, 
            List.of(categoryName),
            images, 
            reviews
        );
    }
}